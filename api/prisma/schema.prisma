datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

//
// -------------------------
// ENUMS (NEMIS-aligned)
// -------------------------
//

// -------------------------
// TIME & CALENDAR
// -------------------------
enum DayOfWeek {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

// -------------------------
// LEAVE MANAGEMENT
// -------------------------
enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum LeaveReason {
  SICK
  OFFICIAL
  PERSONAL
  OTHER
}

// School Type (MOE official classification)
enum SchoolType {
  ONE_AB // "1AB"
  ONE_C // "1C"
  TYPE_2 // "2"
  TYPE_3 // "3"
  OTHER
}

// School teaching mediums
enum SchoolMedium {
  SINHALA
  TAMIL
  ENGLISH
}

// System user roles (RBAC)
enum UserRole {
  SUPER_ADMIN
  SCHOOL_ADMIN
  PRINCIPAL
  TEACHER
  CLERK
  PARENT
}

enum TeacherAppointmentType {
  PERMANENT
  TEMPORARY
  VOLUNTEER
  CONTRACT
}

enum TeacherEmploymentStatus {
  ACTIVE
  TRANSFERRED
  RETIRED
  RELEASED
  DECEASED
  RESIGNED
}

enum Gender {
  MALE
  FEMALE
}

enum Religion {
  BUDDHIST
  HINDU
  ISLAM
  CATHOLIC
  CHRISTIAN
  OTHER
}

enum Ethnicity {
  SINHALA
  SRI_LANKAN_TAMIL
  INDIAN_TAMIL
  MUSLIM
  BURGHER
  MALAY
  OTHER
}

enum MotherTongue {
  SINHALA
  TAMIL
  ENGLISH
}

enum AdmissionStatus {
  NEW // first time in school
  PROMOTED // standard promotion
  REPEATED // repeated grade
  TRANSFERRED_IN // new from another school
  TRANSFERRED_OUT // left to another school
}

enum TeacherClassRole {
  CLASS_TEACHER
  SUBJECT_TEACHER
  ASSISTANT_TEACHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum GradeLevel {
  PRIMARY // Grades 1‚Äì5
  JUNIOR // Grades 6‚Äì9
  ORDINARY_LEVEL // Grades 10‚Äì11 (O/L)
  ADVANCED_LEVEL // Grades 12‚Äì13 (A/L)
}

enum AddressType {
  PERMANENT
  CURRENT
}

enum TimetableOverrideReason {
  SUBSTITUTION
  TEMP_CHANGE
  OTHER
}

//
// -------------------------
// STUDENT PROFILE
// -------------------------

model StudentProfile {
  id String @id @default(uuid())

  /// Tenant (school) this student belongs to
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  /// Identity fields
  fullName    String
  initials    String?
  dateOfBirth DateTime
  gender      Gender

  // üîë SYSTEM CODE (QR / BARCODE)
  systemCode String

  /// NEMIS extensions (Step 4A)
  nic                String? // optional (mandatory if age >= 15)
  birthCertificateNo String?
  civilStatus        String? // SINGLE, MARRIED, etc. (enum later)
  medium             SchoolMedium?

  /// NEMIS-required identifiers
  indexNumber     String // Student Index Number (SIS)
  admissionNumber String
  admissionDate   DateTime

  /// Demographic attributes
  motherTongue MotherTongue
  religion     Religion
  ethnicity    Ethnicity

  /// Status flags
  isActive Boolean @default(true)

  /// For optimistic concurrency control
  rowVersion Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enrollments       StudentGradeClass[]
  familyLinks       StudentParent[] // NEW
  attendanceRecords Attendance[] // NEW
  addresses         StudentAddress[]
  gateAttendances   GateAttendance[]

  // üîí Must be unique per school
  @@unique([tenantId, systemCode])
  // Constraints required by NEMIS
  @@unique([tenantId, indexNumber])
  @@unique([tenantId, admissionNumber])
  // Useful indexes
  @@index([tenantId])
  @@index([gender])
  @@index([isActive])
}

model StudentAddress {
  id        String @id @default(uuid())
  tenantId  String
  studentId String

  type           AddressType
  addressLine1   String
  addressLine2   String?
  city           String?
  gsDivisionCode String
  districtCode   String

  telephone        String?
  mobile           String
  residingFromDate DateTime?

  student StudentProfile @relation(fields: [studentId], references: [id])
  tenant  Tenant         @relation(fields: [tenantId], references: [id])

  createdAt DateTime @default(now())

  @@index([tenantId, studentId])
}

model StudentGradeClass {
  id String @id @default(uuid())

  /// Links
  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])

  gradeId String
  grade   Grade  @relation(fields: [gradeId], references: [id])

  classId   String
  classroom Classroom @relation(fields: [classId], references: [id])

  academicYearId Int
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  /// NEMIS-required admission status
  admissionStatus AdmissionStatus

  /// Reasons for transfer / repeat / etc.
  transferReason String?

  /// Index or roll number inside the class
  classIndex Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// A student should have only ONE enrollment per academic year per school
  /// NEMIS requirement, avoids duplicates
  @@unique([studentId, academicYearId])
  /// Performance indexes
  @@index([classId])
  @@index([gradeId])
  @@index([academicYearId])
}

model Grade {
  id String @id @default(uuid())

  /// Grade number: 1‚Äì13 (required by MOE)
  gradeNumber Int

  /// Explicit grade category (PRIMARY, JUNIOR, O/L, A/L)
  gradeLevel GradeLevel // ‚¨ÖÔ∏è ADD HERE

  /// Optional grade display name
  name String?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  academicYearId Int?
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])

  classrooms Classroom[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentEnrollments StudentGradeClass[]
  teacherAssignments TeacherGradeClass[]

  @@unique([tenantId, gradeNumber])
  @@index([tenantId])
}

model Classroom {
  id String @id @default(uuid())

  /// Class belongs to a Grade
  gradeId String
  grade   Grade  @relation(fields: [gradeId], references: [id])

  /// Multi-tenant safety
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  /// Class name/section (A, B, C‚Ä¶)
  className String

  /// e.g., ‚Äú6B‚Äù, ‚Äú10A‚Äù
  classCode String

  /// Optional capacity (future use)
  capacity Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentEnrollments StudentGradeClass[]
  teacherAssignments TeacherGradeClass[]
  attendanceRecords  Attendance[]
  timetableSlots     TimetableSlot[]

  /// Prevents: school ‚Üí grade 6 ‚Üí class B repeated twice
  @@unique([tenantId, gradeId, className])
  /// Prevent duplicate classCode inside same tenant
  @@unique([tenantId, classCode])
  @@index([tenantId])
  @@index([gradeId])
}

//
// -------------------------
// TEACHER PROFILE
// -------------------------
model TeacherProfile {
  id String @id @default(uuid())

  /// Tenant (School) this teacher belongs to
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  /// Optional link to auth user account
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  /// Full name (as per NIC / NEMIS entry)
  fullName String
  initials String?

  // üîë SYSTEM CODE (QR / BARCODE)
  systemCode String

  /// National Identity Card number
  nic String @unique

  /// Teacher Identity Number (TIN) ‚Äì nationally unique
  tin String @unique

  /// LEGACY: Phase-1 quick subject tags (we keep this for now)
  subjectCodes String[]

  /// Appointment type: Permanent, Temporary, Volunteer, Contract
  appointmentType TeacherAppointmentType

  /// Teacher‚Äôs service start date in this school
  serviceStart DateTime

  /// NEMIS employment status
  employmentStatus TeacherEmploymentStatus @default(ACTIVE)

  // DEMOGRAPHIC INFO
  dateOfBirth  DateTime
  gender       Gender
  motherTongue MotherTongue
  religion     Religion
  ethnicity    Ethnicity

  /// Standard timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  classAssignments   TeacherGradeClass[]
  subjects           TeacherSubject[]
  markedAttendances  Attendance[]
  timetableSlots     TimetableSlot[]
  teacherLeaves      TeacherLeave[]
  timetableOverrides TimetableOverride[] @relation("OverrideTeacher")

  // üîí Must be unique per school
  @@unique([tenantId, systemCode])
  @@index([tenantId])
  @@index([tin])
  @@index([nic])
}

model TeacherGradeClass {
  id String @id @default(uuid())

  /// Links
  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id])

  gradeId String
  grade   Grade  @relation(fields: [gradeId], references: [id])

  classId   String
  classroom Classroom @relation(fields: [classId], references: [id])

  academicYearId Int
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  /// Class role: class teacher, subject teacher...
  roleInClass TeacherClassRole

  /// NEW: proper relation to Subject (instead of subjectCode String?)
  subjectId String?
  subject   Subject? @relation(fields: [subjectId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// Updated unique: allow multiple teachers per class/year,
  /// but not duplicate same teacher+subject+class+year
  @@unique([teacherId, classId, academicYearId, subjectId])
  @@index([gradeId])
  @@index([classId])
  @@index([academicYearId])
}

model TimetableSlot {
  id String @id @default(uuid())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  academicYearId Int
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  dayOfWeek    DayOfWeek
  periodNumber Int

  startTime String // "07:45"
  endTime   String // "08:25"

  classId   String
  classroom Classroom @relation(fields: [classId], references: [id])

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id])

  room String? // optional (gov schools often change rooms)

  isActive Boolean @default(true)

  timetableOverrides TimetableOverride[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Prevent contradictions: same class cannot have 2 teachers for same day/period/year
  @@unique([tenantId, academicYearId, classId, dayOfWeek, periodNumber])
  @@index([tenantId, academicYearId])
  @@index([tenantId, teacherId])
  @@index([tenantId, classId])
}

model TimetableOverride {
  id String @id @default(uuid())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  academicYearId Int
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  // Link to base weekly slot
  slotId String
  slot   TimetableSlot @relation(fields: [slotId], references: [id])

  dateFrom DateTime
  dateTo   DateTime

  overrideTeacherId String?
  overrideTeacher   TeacherProfile? @relation("OverrideTeacher", fields: [overrideTeacherId], references: [id])
  overrideSubjectId String?
  overrideSubject   Subject?        @relation(fields: [overrideSubjectId], references: [id])

  reason TimetableOverrideReason @default(SUBSTITUTION)
  note   String?

  isActive Boolean @default(true)

  createdByUserId String?
  createdBy       User?   @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, academicYearId])
  @@index([tenantId, slotId])
  @@index([tenantId, dateFrom, dateTo])
  @@index([tenantId, overrideTeacherId])
}

model TeacherLeave {
  id String @id @default(uuid())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id])

  academicYearId Int?
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])

  dateFrom DateTime
  dateTo   DateTime

  reasonCode LeaveReason
  note       String?

  status LeaveStatus @default(PENDING)

  requestedAt DateTime @default(now())

  approvedByUserId String?

  approvedBy User? @relation("LeaveApprover", fields: [approvedByUserId], references: [id], onDelete: SetNull)

  approvedAt DateTime?

  decisionNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, teacherId])
  @@index([tenantId, status])
  @@index([tenantId, dateFrom, dateTo])
}

// -------------------------
// SUBJECTS & TEACHER SUBJECTS
// -------------------------

model Subject {
  id String @id @default(uuid())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  /// Short subject code (e.g. "SCI_G6_11")
  code String

  /// Human-friendly name
  name String

  /// PRIMARY / JUNIOR / O/L / A/L
  gradeLevel GradeLevel // ‚¨ÖÔ∏è ADD

  /// Used mainly for O/L & A/L
  isExamSubject   Boolean @default(false)
  isCreditBearing Boolean @default(false)
  credits         Int?

  /// A/L stream only (SCIENCE / COMMERCE / ARTS / TECHNOLOGY / VOCATIONAL)
  stream String?

  /// Curriculum version (pre-2026, 2026 reform, etc.)
  curriculumId String
  curriculum   Curriculum @relation(fields: [curriculumId], references: [id])

  /// Grades for which this subject is valid
  validGrades Int[]

  /// Relations
  teacherSubjects    TeacherSubject[]
  classAssignments   TeacherGradeClass[]
  timetableSlots     TimetableSlot[]
  timetableOverrides TimetableOverride[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code, curriculumId])
  @@index([tenantId])
  @@index([gradeLevel])
}

model TeacherSubject {
  id String @id @default(uuid())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id])

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, teacherId, subjectId])
  @@index([tenantId, teacherId])
  @@index([tenantId, subjectId])
}

// -------------------------
// PARENTS & FAMILY LINKS
// -------------------------

model Parent {
  id String @id @default(uuid())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  /// Linked auth user (role = PARENT)
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName String
  lastName  String
  phone     String?
  nic       String? @unique

  /// Many-to-many with students via junction table
  students StudentParent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model StudentParent {
  id String @id @default(uuid())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])

  parentId String
  parent   Parent @relation(fields: [parentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  isPrimaryGuardian Boolean @default(true)

  @@unique([tenantId, studentId, parentId])
  @@index([tenantId, studentId])
  @@index([tenantId, parentId])
}

// -------------------------
// ATTENDANCE
// -------------------------

model Attendance {
  id String @id @default(uuid())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])

  classId   String
  classroom Classroom @relation(fields: [classId], references: [id])

  academicYearId Int
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  /// Date of attendance (normalized to 00:00)
  date DateTime

  /// Period number (1,2,3‚Ä¶)
  period Int

  status AttendanceStatus

  markedByTeacherId String?
  markedByTeacher   TeacherProfile? @relation(fields: [markedByTeacherId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// üîí ONE record per student per class per period per day
  @@unique([tenantId, classId, academicYearId, studentId, date, period])
  /// üîç Performance indexes
  @@index([tenantId, date])
  @@index([classId, date])
}

model GateAttendance {
  id String @id @default(uuid())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])

  academicYearId Int
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id])

  /// Date normalized to 00:00
  date DateTime

  /// Time student entered school
  arrivalTime DateTime?

  /// PRESENT | LATE | ABSENT
  status AttendanceStatus

  /// Optional gate device identifier
  scannedByDevice String?

  createdAt DateTime @default(now())

  /// One gate record per student per day per academic year
  @@unique([studentId, academicYearId, date])
  /// Performance indexes (NON-NEGOTIABLE)
  @@index([tenantId, date])
  @@index([status])
}

//
// -------------------------
// USER & AUTHENTICATION MODELS
// -------------------------
model User {
  id String @id @default(uuid())

  /// Nullable for SUPER_ADMIN (system-wide)
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  email        String
  passwordHash String

  role     UserRole
  isActive Boolean  @default(true)

  /// INVITE TRACKING (STEP 4C-4)
  invitePending Boolean   @default(false)
  invitedAt     DateTime?
  inviteSentAt  DateTime?

  /// Security / brute-force protection
  failedLoginAttempts Int       @default(0)
  lockUntil           DateTime?

  lastLoginAt DateTime?

  /// Optimistic concurrency control
  rowVersion Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// Relations
  refreshTokens             RefreshToken[]
  auditLogs                 AuditLog[]
  inviteTokens              InviteToken[]
  approvedLeaves            TeacherLeave[]      @relation("LeaveApprover")
  createdTimetableOverrides TimetableOverride[]

  teacherProfile TeacherProfile?
  parentProfile  Parent?

  /// Email is unique per tenant (SUPER_ADMIN unique because tenantId=null)
  @@unique([tenantId, email])
  /// Useful for queries and dashboards
  @@index([tenantId, role])
  @@index([isActive])
}

model InviteToken {
  id     String @id @default(uuid())
  token  String @unique
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model RefreshToken {
  id String @id @default(uuid())

  /// Which user this token belongs to
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// Hashed refresh token (never store raw)
  tokenHash String

  /// Token lifecycle
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  @@index([userId])
  @@index([expiresAt])
}

//
// -------------------------
// TENANT (SCHOOL)
// -------------------------
model Tenant {
  id   String @id @default(uuid())
  name String

  /// MOE school census number (unique national ID)
  schoolCode String @unique

  /// MOE school category (1AB, 1C, Type 2, Type 3)
  schoolType SchoolType

  /// Location metadata for NEMIS
  province String?
  district String
  zone     String
  division String

  /// Mediums offered (Sinhala/Tamil/English)
  mediums            SchoolMedium[]
  inviteOutbox       InviteOutbox[]
  gateAttendances    GateAttendance[]
  timetableSlots     TimetableSlot[]
  teacherLeaves      TeacherLeave[]
  timetableOverrides TimetableOverride[]

  /// Optional address fields
  addressLine1 String?
  addressLine2 String?
  city         String?

  /// Geo-coordinates for analytics or school maps
  latitude  Float?
  longitude Float?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// RELATIONS
  users            User[]
  teacherProfiles  TeacherProfile[] // all teachers in this school
  studentProfiles  StudentProfile[]
  grades           Grade[]
  classrooms       Classroom[]
  auditLogs        AuditLog[]
  studentAddresses StudentAddress[]

  // NEW:
  subjects        Subject[]
  parents         Parent[]
  teacherSubjects TeacherSubject[]
  studentParents  StudentParent[]
  attendance      Attendance[]

  /// Recommended indexes for NEMIS-level reporting
  @@index([district, zone])
  @@index([schoolType])
  @@index([isActive])
}

//
// -------------------------
// CURRICULUM (SYLLABUS VERSIONING)
// -------------------------
model Curriculum {
  id String @id @default(uuid())

  /// Human label
  name String // e.g. "Pre-2026", "2026 Reform", "O/L 2028 Reform"

  /// First year this curriculum applies
  startYear Int

  /// Optional end year (null = still active)
  endYear Int?

  isActive Boolean @default(false)

  createdAt DateTime @default(now())

  /// Reverse relations
  subjects Subject[]
}

//
// -------------------------
// ACADEMIC YEAR
// -------------------------
model AcademicYear {
  id          Int      @id @default(autoincrement())
  label       String // "2025", "2025/2026"
  numericYear Int?
  start       DateTime
  end         DateTime
  active      Boolean  @default(false)

  /// Reverse relation for Grade.academicYear
  grades             Grade[]
  studentEnrollments StudentGradeClass[]
  teacherAssignments TeacherGradeClass[]
  attendanceRecords  Attendance[]
  gateAttendances    GateAttendance[]
  timetableSlots     TimetableSlot[]
  teacherLeaves      TeacherLeave[]
  timetableOverrides TimetableOverride[]

  @@unique([label])
  @@index([active])
}

enum InviteChannel {
  EMAIL
}

enum InviteStatus {
  PENDING
  SENT
  FAILED
}

model InviteOutbox {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  channel InviteChannel @default(EMAIL)
  status  InviteStatus  @default(PENDING)

  toEmail     String
  subject     String
  payloadJson String // store message data (temp password, student name, etc.)

  error    String?
  attempts Int     @default(0)

  createdAt DateTime  @default(now())
  sentAt    DateTime?

  @@index([tenantId, status])
  @@index([status, createdAt])
}

model AuditLog {
  id String @id @default(uuid())

  /// School-level multi-tenant isolation
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  /// User who performed the action (nullable for system events)
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  /// Action identifier (e.g., LOGIN_SUCCESS, USER_CREATED)
  actionCode String

  /// JSON payload storing relevant info (field changes, entity IDs, etc.)
  detailsJson String?

  /// Client metadata
  ipAddress String?
  userAgent String?

  /// Retention: logs can be purged after this date
  retentionUntil DateTime?

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([actionCode])
  @@index([createdAt])
}
