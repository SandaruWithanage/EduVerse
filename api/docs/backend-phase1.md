# ğŸ“˜ EduVerse Backend - Phase 1 Technical Documentation

**Version:** 1.0  
**Status:** Phase 1 Complete (Foundation, Auth, RLS, Multi-tenancy)  
**Date:** November 2025

---

## 1. ğŸ“‚ Project Structure & Architecture

The backend follows a modular **NestJS** architecture with a specific focus on security and multi-tenancy.

```text
api/
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ migrations/       # Database schema history
â”‚   â”œâ”€â”€ schema.prisma     # Single source of truth for DB models
â”‚   â””â”€â”€ seed.js           # Seeding script for initial data
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app.module.ts     # Root module (Global Guards registered here)
â”‚   â”œâ”€â”€ main.ts           # Entry point (CORS, ValidationPipes)
â”‚   â”œâ”€â”€ prisma.service.ts # Custom Prisma Service with RLS extension
â”‚   â”‚
â”‚   â”œâ”€â”€ auth/             # Authentication Module
â”‚   â”‚   â”œâ”€â”€ guards/       # JwtAuthGuard, RolesGuard
â”‚   â”‚   â”œâ”€â”€ strategies/   # Passport JWT strategy extraction
â”‚   â”‚   â””â”€â”€ auth.service.ts # Login, Logout, Token Rotation logic
â”‚   â”‚
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ filters/      # Global Exception Filter (standardized errors)
â”‚   â”‚   â””â”€â”€ interceptors/ # RLS Interceptor (Critical for Tenant Isolation)
â”‚   â”‚
â”‚   â”œâ”€â”€ tenant/           # Tenant Management (School creation)
â”‚   â”œâ”€â”€ users/            # User Management
â”‚   â”œâ”€â”€ students/         # Student Data (RLS Protected)
â”‚   â””â”€â”€ teachers/         # Teacher Data (RLS Protected)
â””â”€â”€ test/
    â””â”€â”€ app.e2e-spec.ts   # End-to-End automated test suite
```

-----

## 2\. ğŸ” Authentication Flow (JWT + Rotation)

We use a secure **Dual-Token System** to manage user sessions.

### A. Login (`POST /api/auth/login`)

1.  User submits `email` + `password`.
2.  Server verifies credentials against hashed passwords (Bcrypt).
3.  Server generates two tokens:
      * **Access Token (Short-lived):** Contains `sub` (userId), `role`, and `tenantId`.
      * **Refresh Token (Long-lived):** Hashed and stored in the database (`RefreshToken` table).
4.  Audit Log records `LOGIN_SUCCESS`.

### B. Accessing Protected Routes

1.  Client sends `Authorization: Bearer <access_token>`.
2.  **JwtAuthGuard** validates the signature.
3.  **RolesGuard** checks if the user's role matches the `@Roles(...)` decorator.
4.  **RlsInterceptor** injects the user's `tenantId` into the database session.

### C. Refresh Token Rotation (`POST /api/auth/refresh`)

1.  Client sends the *old* refresh token.
2.  Server validates the token and checks the DB.
3.  **Rotation:** The old token is deleted (invalidated).
4.  A **new** pair of Access/Refresh tokens is issued.
5.  This prevents "replay attacks" if a refresh token is stolen.

-----

## 3\. ğŸ›¡ï¸ Row-Level Security (RLS) Implementation

This is the core of our Multi-Tenancy. We do **not** manually filter by `where: { tenantId }` in every query. Instead, we enforce isolation at the database driver level.

### How it Works

1.  **Interceptor:** The `RlsInterceptor` intercepts every request.
2.  **Context Injection:** It extracts the `user` object from the request.
3.  **Session Variable:** It calls `prisma.$executeRawUnsafe` to set PostgreSQL session variables:
      * `app.tenant_id` = `user.tenantId`
      * `app.role` = `user.role`
4.  **Query Execution:** Any subsequent query (e.g., `findMany`) is executed within this "sandboxed" transaction.
5.  **Database Policy:** PostgreSQL Policies (defined in migrations) automatically block access to rows where `tenantId` does not match `app.tenant_id`.

**Super Admin Exception:**
If `app.role` is `SUPER_ADMIN`, the RLS policy is designed to bypass the filter, allowing cross-tenant visibility.

-----

## 4\. ğŸ”„ Migration Instructions

To modify the database schema:

1.  **Edit Schema:** Modify `api/prisma/schema.prisma`.
2.  **Create Migration:**
    ```bash
    npx prisma migrate dev --name <descriptive_name>
    ```
    *Example:* `npx prisma migrate dev --name add_parent_details`
3.  **Apply to Production (CI/CD):**
    ```bash
    npx prisma migrate deploy
    ```

**âš ï¸ Critical Note:** If you modify RLS policies, you must manually edit the SQL migration file generated by Prisma before running it, as Prisma Schema Language does not fully support complex RLS logic yet.

-----

## 5\. ğŸŒ± Seeding Instructions

The seed script populates the database with a demo environment.

**Command:**

```bash
npx prisma db seed
```

**What it Creates:**

1.  **1 Tenant:** "Demo National School"
2.  **1 Super Admin:** `superadmin@eduverse.local` / `password123`
3.  **1 School Admin:** `schooladmin@demo.edu` / `password123`
4.  **Reference Data:** Academic Year (2025/2026), Grades 1-13.
5.  **Dummy Data:** 4 Teachers, 4 Students.

-----

## 6\. ğŸ‘® RBAC Matrix (Role-Based Access Control)

Access is controlled via the `@Roles()` decorator.

| Role | Scope | Permissions |
| :--- | :--- | :--- |
| **SUPER\_ADMIN** | **Global** | Can manage Tenants, create School Admins, view all data across all schools. |
| **SCHOOL\_ADMIN** | **Tenant** | Can manage Users, Teachers, Classes, and Students *only within their own school*. |
| **PRINCIPAL** | **Tenant** | Read-only access to school statistics, reports, and staff/student directories. |
| **TEACHER** | **Tenant** | Can view assigned Classes and Students. Cannot manage other users. |
| **CLERK** | **Tenant** | Can edit Student profiles and handle admissions. |
| **STUDENT** | **Tenant** | (Future Phase) View own grades and schedule. |

-----

## 7\. âœ… Testing

We use **Jest** and **Supertest** for End-to-End (E2E) testing.

**Run All Tests:**

```bash
npm run test:e2e
```

**Current Test Coverage:**

  * âœ… Auth (Login, Token Refresh)
  * âœ… User Management (CRUD)
  * âœ… Tenant Isolation (RLS Verification)
  * âœ… Student/Teacher Endpoints (Security Checks)
